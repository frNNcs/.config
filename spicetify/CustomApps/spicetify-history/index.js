var spicetifyDhistory=(()=>{var e,t,a=Object.create,o=Object.defineProperty,n=Object.getOwnPropertyDescriptor,l=Object.getOwnPropertyNames,i=Object.getPrototypeOf,s=Object.prototype.hasOwnProperty,c=(t,r,a,i)=>{if(r&&"object"==typeof r||"function"==typeof r)for(let e of l(r))s.call(t,e)||e===a||o(t,e,{get:()=>r[e],enumerable:!(i=n(r,e))||i.enumerable});return t},r=(e,t,r)=>(r=null!=e?a(i(e)):{},c(!t&&e&&e.__esModule?r:o(r,"default",{value:e,enumerable:!0}),e)),u=(e={"external-global-plugin:react"(e,t){t.exports=Spicetify.React}},function(){return t||(0,e[l(e)[0]])((t={exports:{}}).exports,t),t.exports}),d={},N=(((e,t)=>{for(var r in t)o(e,r,{get:t[r],enumerable:!0})})(d,{default:()=>function(){return y.default.createElement(m,null)}}),r(u())),D=a=>new Promise((t,r)=>{var e=a.transaction(["history"],"readonly").objectStore("history").getAll();e.onerror=e=>{e=(null==(e=e.target.error)?void 0:e.message)||"Unknown error";console.error("Error retrieving history:",e),r(e)},e.onsuccess=e=>{e=e.target.result;t(e)}}),k=e=>{var t;return"string"==typeof e.uid&&"string"==typeof e.uri&&"string"==typeof e.name&&"number"==typeof(null==(t=e.duration)?void 0:t.milliseconds)&&"string"==typeof(null==(t=e.album)?void 0:t.name)&&"string"==typeof(null==(t=e.album)?void 0:t.uri)&&Array.isArray(e.artists)&&e.artists.every(e=>"string"==typeof e.name&&"string"==typeof e.uri)&&"number"==typeof e.listenDate&&Array.isArray(e.images)&&e.images.every(e=>"string"==typeof e.label&&"string"==typeof e.url)&&"object"==typeof e.metadata&&null!==e.metadata},m=()=>{let[t,a]=(0,N.useState)(void 0),[i,o]=(0,N.useState)([]),n=(0,N.useRef)(null),[e,l]=(0,N.useState)([]),[r,s]=(0,N.useState)(""),[c,u]=(0,N.useState)({key:"date",ascending:!1}),d=(0,N.useRef)(null),m=(0,N.useRef)(null),[y,f]=(0,N.useState)(1),p=(0,N.useCallback)(async()=>{try{var e=await(()=>{let a;return new Promise((t,r)=>{var e=indexedDB.open("SpicetifyHistoryDB",1);e.onerror=e=>{var t=(null==(t=e.target.error)?void 0:t.message)||"Unknown error";console.error("Database error:",e.target.error),r(t)},e.onsuccess=e=>{a=e.target.result,console.log("Database opened successfully"),t(a)},e.onupgradeneeded=e=>{var e=e.target.result;e.objectStoreNames.contains("history")||((e=e.createObjectStore("history",{keyPath:"uid"})).createIndex("name","name",{unique:!1}),e.createIndex("uri","uri",{unique:!0}),e.createIndex("listenDate","listenDate",{unique:!1}),console.log("Object store 'history' created"))}})})(),t=await D(e),r=(a(e),g(t,c));o(r),l(r)}catch(e){console.error("Failed to fetch history:",e)}},[c]),g=(e,a)=>{e=[...e].sort((e,t)=>{var r;return"name"===a.key?e.name.localeCompare(t.name):"album"===a.key?((null==(r=e.album)?void 0:r.name)||"").localeCompare((null==(r=t.album)?void 0:r.name)||""):"date"===a.key?e.listenDate-t.listenDate:"duration"===a.key?e.duration.milliseconds-t.duration.milliseconds:0});return a.ascending||e.reverse(),e};(0,N.useEffect)(()=>{p()},[p]),(0,N.useEffect)(()=>{let e=()=>{p();var e=null==(e=Spicetify.Player.data)?void 0:e.item;e&&"track"===e.type&&(m.current=e.uri,d.current=e.uid)};return Spicetify.Player.addEventListener("onplaypause",e),Spicetify.Player.addEventListener("songchange",e),()=>{Spicetify.Player.removeEventListener("songchange",e),Spicetify.Player.removeEventListener("onplaypause",e)}},[p]),(0,N.useEffect)(()=>()=>{n.current&&clearTimeout(n.current)},[]);let h=e=>{t=e.listenDate,a=new Date,(r=new Date).setDate(a.getDate()-1);var t,r,a=t<r.getTime()||e.dateFinalized;return((e,t)=>{var r=new Date(e);if(!t){var t=new Date,e=t.getTime()-e,e=Math.floor(e/6e4);if(e<1)return"Just now";if(e<60)return e+` min${1<e?"s":""} ago`;if(e<1440)return(e=Math.floor(e/60))+` hour${1<e?"s":""} ago`;e=new Date(t);if(e.setDate(t.getDate()-1),r.getDate()===e.getDate()&&r.getMonth()===e.getMonth()&&r.getFullYear()===e.getFullYear())return"Yesterday"}return r.getHours().toString().padStart(2,"0")+`:${r.getMinutes().toString().padStart(2,"0")} / ${String(r.getMonth()+1).padStart(2,"0")} / ${String(r.getDate()).padStart(2,"0")} / `+String(r.getFullYear()).slice(-2)})(e.listenDate,a)};let v=async e=>{if(t)try{await(async(e,t)=>{Spicetify.showNotification("Importing history...");try{if(e&&t){var r,a=await t.text(),i=JSON.parse(a),o=e.transaction(["history"],"readwrite"),n=o.objectStore("history");for(r of i){if(!k(r))throw new Error("Invalid song data in imported file");n.add(r)}o.oncomplete=()=>{Spicetify.showNotification("History imported")},o.onerror=e=>{console.error("Error importing history:",e.target.error),Spicetify.showNotification("Failed to import history")}}}catch(e){Spicetify.showNotification("Failed to import history"),console.error("Error importing history:",e)}})(t,e),p(),Spicetify.PopupModal.hide()}catch(e){console.error("Failed to import history:",e)}else Spicetify.showNotification("Database not ready")},S=async e=>{if(t)try{a=t,i=e,await new Promise((t,r)=>{Spicetify.showNotification("Deleting song...");var e=a.transaction(["history"],"readwrite").objectStore("history").delete(i);e.onerror=e=>{var t=(null==(t=e.target.error)?void 0:t.message)||"Unknown error";console.error("Error deleting song:",e.target.error),Spicetify.showNotification("Failed to delete song"),r(t)},e.onsuccess=e=>{console.log("Successfully deleted song."),Spicetify.showNotification("Song deleted"),t()}}),p()}catch(e){console.error("Failed to delete song:",e)}var a,i},b=t=>{u(e=>({key:t,ascending:e.key!==t||!e.ascending}))};var E=50*(y-1),w=50*y,E=e.slice(E,w),w=Math.ceil(e.length/50);return N.default.createElement("div",{className:"historyPage"},N.default.createElement("div",{className:"header"},N.default.createElement("h1",null,"History")),N.default.createElement("div",{className:"controls"},N.default.createElement("div",{className:"buttonsContainer"},N.default.createElement("button",{onClick:async()=>{if(t)try{a=t,await new Promise((t,r)=>{Spicetify.showNotification("Clearing history...");var e=a.transaction(["history"],"readwrite").objectStore("history").clear();e.onerror=e=>{var t=(null==(t=e.target.error)?void 0:t.message)||"Unknown error";console.error("Error clearing history:",e.target.error),Spicetify.showNotification("Failed to clear history"),r(t)},e.onsuccess=e=>{console.log("Successfully cleared history."),Spicetify.showNotification("History cleared"),t()}}),p()}catch(e){console.error("Failed to clear history:",e)}var a}},"Clear history"),N.default.createElement("button",{onClick:async()=>{if(t)try{await(async e=>{Spicetify.showNotification("Exporting history...");try{var t,r,a,i,o=await D(e);0===o.length?Spicetify.showNotification("No history to export"):(o.sort((e,t)=>e.listenDate-t.listenDate),t=JSON.stringify(o,null,2),r=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(r),(i=document.createElement("a")).href=a,i.download="spicetify-history-download",i.click(),i.remove(),URL.revokeObjectURL(a),Spicetify.showNotification("History exported"))}catch(e){console.error("Error exporting history:",e),Spicetify.showNotification("Failed to export history")}})(t)}catch(e){console.error("Failed to export history:",e)}}},"Export history"),N.default.createElement("button",{onClick:()=>{Spicetify.PopupModal.display({title:"Import History",content:`
                  <div id="import_history_modal">
                    <div class="fileInputContainer">
                      <label for="import_file_input" class="custom-file-upload">&#10514;</label>
                      <input 
                        id="import_file_input" 
                        type="file" 
                        name="file" 
                        accept=".json"
                        required 
                      />
                    </div>
                    <button id="import_history_button">Import</button>
                  </div>
                `}),setTimeout(()=>{var e=document.querySelector(".main-trackCreditsModal-container"),t=document.getElementById("import_history_modal");let r=document.getElementById("import_file_input");var a=document.getElementById("import_history_button");e&&t&&r&&a?(e.classList.add("importHistoryModalContainer"),t.classList.add("importHistoryModal"),r.classList.add("fileInput"),a.classList.add("importButton"),a.addEventListener("click",async()=>{var e;r.files&&0!==r.files.length?(e=r.files[0],await v(e)):Spicetify.showNotification("Please select a file")})):(Spicetify.showNotification("Modal not found"),console.error("Modal elements not found, retrying..."))},100)}},"Import history")),N.default.createElement("div",{className:"searchContainer"},N.default.createElement("input",{type:"text",placeholder:"Search history...",value:r,onChange:e=>{let r=e.target.value.toLowerCase();s(r),n.current&&clearTimeout(n.current),n.current=setTimeout(()=>{var e=i.filter(e=>{var t;return e.name.toLowerCase().includes(r)||(null==(t=null==(t=e.album)?void 0:t.name)?void 0:t.toLowerCase().includes(r))||(null==(t=e.artists)?void 0:t.some(e=>e.name.toLowerCase().includes(r)))});l(e)},300)},className:"searchInput"}))),N.default.createElement("div",{className:"songList"},N.default.createElement("div",{className:"songListHeaderRow"},N.default.createElement("div",{className:"headerIndex"},"#"),N.default.createElement("div",{onClick:()=>b("name"),className:"headerTitle"},"Title"),N.default.createElement("div",{onClick:()=>b("album"),className:"headerAlbum"},"Album"),N.default.createElement("div",{onClick:()=>b("date"),className:"headerDate"},"Date Added"),N.default.createElement("div",{onClick:()=>b("duration"),className:"headerDuration"},"Duration"),N.default.createElement("div",null)),0===E.length?N.default.createElement("p",null,"No history available."):E.map((r,e)=>{var t;return N.default.createElement("div",{key:r.uid||e,className:"songRow"},N.default.createElement("div",{className:"songIndex"},N.default.createElement("span",{className:"indexNumber"},50*(y-1)+e+1),N.default.createElement("span",{className:"playPauseIcon",onClick:()=>{var e,t;e=r.uri,t=r.uid,Spicetify&&Spicetify.Player&&(e===m.current?Spicetify.Player.isPlaying()?Spicetify.Player.pause():Spicetify.Player.play():Spicetify.Player.playUri(e).then(()=>{m.current=e,d.current=t}))}},N.default.createElement("svg",{dangerouslySetInnerHTML:{__html:r.uid!==d.current&&r.uri!==m.current||!Spicetify.Player.isPlaying()?Spicetify.SVGIcons.play:Spicetify.SVGIcons.pause}}))),N.default.createElement("div",{className:"songDetails"},N.default.createElement("div",{className:"songImageContainer"},N.default.createElement("img",{src:(null==(e=null==(e=r.images)?void 0:e[0])?void 0:e.url)||"/default-image.png",alt:r.name,className:"songImage"})),N.default.createElement("div",{className:"songDetailsText"},N.default.createElement("div",{className:"songName",title:r.name},50<r.name.length?r.name.substring(0,50)+"...":r.name),N.default.createElement("div",{className:"songArtist",onClick:()=>{var e;return Spicetify.Platform.History.push("/artist/"+(null==(e=r.artists)?void 0:e[0].uri.split(":")[2]))}},null==(e=r.artists)?void 0:e.map(e=>e.name).join(", ")))),N.default.createElement("div",{className:"songAlbum",onClick:()=>{var e;return Spicetify.Platform.History.push("/album/"+(null==(e=r.album)?void 0:e.uri.split(":")[2]))}},50<(null==(e=r.album)?void 0:e.name.length)?`${null==(e=r.album)?void 0:e.name.substring(0,50)}...`:null==(e=r.album)?void 0:e.name),N.default.createElement("div",{className:"songDate"},h(r)),N.default.createElement("div",{className:"songDuration"},(e=r.duration.milliseconds,t=Math.floor(e/6e4),e=(e%6e4/1e3).toFixed(0),t+":"+(parseInt(e)<10?"0":"")+e)),N.default.createElement("div",{className:"songActions"},N.default.createElement("button",{onClick:()=>S(r.uid)},"X")))}),N.default.createElement("div",{className:"paginationContainer"},N.default.createElement("button",{onClick:()=>f(e=>Math.max(e-1,1))},"<"),N.default.createElement("span",null,"Page ",y),N.default.createElement("button",{onClick:()=>f(e=>e+1),disabled:y>=w},">"))))},y=r(u());return r=d,c(o({},"__esModule",{value:!0}),r)})();let render=()=>spicetifyDhistory.default();