# default layout (can be bsp, stack or float)
yabai -m config layout bsp

# new window spawns to the right if vertical split, or bottom if horizontal split
yabai -m config window_placement second_child

# -- mouse settings --

# center mouse on window with focus
yabai -m config mouse_follows_focus on

# modifier for clicking and dragging with mouse
yabai -m config mouse_modifier alt
# set modifier + left-click drag to move window
yabai -m config mouse_action1 move
# set modifier + right-click drag to resize window
yabai -m config mouse_action2 resize

# when window is dropped in center of another window, swap them (on edges it will split it)
yabai -m mouse_drop_action swap


# disable specific apps
yabai -m rule --add app="^System Settings$" manage=off
yabai -m rule --add app="^Configuración del Sistema$" manage=off
yabai -m rule --add app="^Calculator$" manage=off
yabai -m rule --add app="^Karabiner-Elements$" manage=off
yabai -m rule --add app="^QuickTime Player$" manage=off
yabai -m rule --add app="^Asistente Configuración Teclado$" manage=off
yabai -m rule --add app="^LinearMouse$" manage=off
yabai -m rule --add app="^Docker Desktop$" manage=off
yabai -m rule --add app="^Acceso: Cuentas de Google$" manage=off
yabai -m rule --add app="^Monitor de Actividad$" manage=off
yabai -m rule --add app="^Raycast Settings$" manage=off
yabai -m rule --add app="^Raycast$" manage=off
yabai -m rule --add app="^Google Drive$" manage=off
yabai -m rule --add app="^ColorSlurp$" manage=off

# -- Multi-Display Padding Configuration --
# Configuración optimizada para mejor rendimiento

# Configuración global por defecto
yabai -m config window_gap 12

# Configuración de padding base para todos los espacios
yabai -m config top_padding 12
yabai -m config bottom_padding 12
yabai -m config left_padding 12
yabai -m config right_padding 12

# Función optimizada para configurar padding dinámicamente
setup_padding() {
    local display_count=$(yabai -m query --displays | jq -r 'length')
    
    # Cache del estado actual para evitar reconfiguración innecesaria
    local current_state_file="$HOME/.config/yabai/.display_state"
    local new_state="displays:$display_count"

    # Verificar si ya está configurado correctamente
    if [ -f "$current_state_file" ] && [ "$(cat "$current_state_file")" = "$new_state" ]; then
        return 0
    fi

    if [ "$display_count" -gt 1 ]; then
        # Múltiples displays: detectar espacios por display y aplicar padding según tipo de display
        echo "Configurando múltiples displays dinámicamente"
        
        # Obtener espacios de cada display y aplicar padding según resolución
        yabai -m query --displays | jq -r '.[] | "\(.id) \(.frame.w) \(.frame.h) \(.spaces | join(" "))"' | while read display_id width height spaces; do
            # Determinar si es laptop (resolución menor) o monitor externo
            if (( $(echo "$width <= 1800 && $height <= 1200" | bc -l) )); then
                # Display laptop: padding 12px (normal)
                padding=12
                echo "Display $display_id (laptop ${width}x${height}): aplicando padding $padding a espacios $spaces"
            else
                # Display externo: padding 46px (para barra)
                padding=46
                echo "Display $display_id (externo ${width}x${height}): aplicando padding $padding a espacios $spaces"
            fi
            
            # Aplicar padding a todos los espacios de este display
            for space in $spaces; do
                yabai -m config --space $space top_padding $padding 2>/dev/null || true
            done
        done
    elif [ "$display_count" -eq 1 ]; then
        # Un solo display: detectar tipo y configurar todos los espacios
        local display_info=$(yabai -m query --displays | jq -r '.[0] | "\(.frame.w) \(.frame.h)"')
        local width=$(echo $display_info | cut -d' ' -f1)
        local height=$(echo $display_info | cut -d' ' -f2)
        
        if (( $(echo "$width <= 1800 && $height <= 1200" | bc -l) )); then
            # Solo laptop: padding 12px (normal)
            echo "Configurando solo laptop: todos los espacios=12px"
            padding=12
        else
            # Solo monitor externo: padding 46px (para barra)
            echo "Configurando solo monitor externo: todos los espacios=46px"  
            padding=46
        fi
        
        # Aplicar a todos los espacios existentes
        yabai -m query --spaces | jq -r '.[].index' | while read space; do
            yabai -m config --space $space top_padding $padding 2>/dev/null || true
        done
    fi

    # Guardar el estado actual
    echo "$new_state" > "$current_state_file"
}

# Configurar padding inicial
setup_padding

# Configurar eventos optimizados (sin restart completo)
yabai -m signal --add event=display_added action="$HOME/.config/yabai/display_handler.sh"
yabai -m signal --add event=display_removed action="$HOME/.config/yabai/display_handler.sh"
